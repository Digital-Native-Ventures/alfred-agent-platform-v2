# Alfred Agent Platform v2 - RAG Service Test Configuration

services:
  # Core infrastructure services required by RAG service
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - alfred-network

  # Vector Database - Qdrant for embeddings
  vector-db:
    image: qdrant/qdrant:v1.7.4
    container_name: vector-db
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - vector-db-data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - alfred-network

  # RAG Service
  agent-rag:
    build:
      context: ./services/rag-service
      dockerfile: Dockerfile
    image: agent-rag:latest
    container_name: agent-rag
    ports:
      - "8501:8501"
    environment:
      - ALFRED_QDRANT_URL=http://vector-db:6333
      - ALFRED_REDIS_URL=redis://redis:6379/0
      - ALFRED_DEFAULT_COLLECTION=general-knowledge
      - ALFRED_ENABLE_COLLECTIONS=true
      - ALFRED_AUTH_ENABLED=true
      - ALFRED_API_KEYS=atlas:atlas-key,alfred:alfred-key,financial:financial-key,legal:legal-key,social:social-key
      - ALFRED_RATE_LIMIT_REQUESTS=100
      - ALFRED_RATE_LIMIT_WINDOW_SECONDS=60
      - ALFRED_LOG_LEVEL=INFO
      - ALFRED_LOG_AGENT_ACCESS=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      vector-db:
        condition: service_started
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - alfred-network

# Volumes
volumes:
  redis-data:
    name: redis-data
  vector-db-data:
    name: vector-db-data

# Networks
networks:
  alfred-network:
    name: alfred-network
    driver: bridge