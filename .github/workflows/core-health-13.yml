name: core-health-13
on:
  pull_request:
    paths:
      - 'docker-compose.yml'
      - 'services/**'
      - 'scripts/**'
      - '.github/workflows/core-health-13.yml'
permissions:
  contents: read
jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: core-health-13-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Docker Hub login
        if: github.event.pull_request.head.repo.full_name == github.repository && secrets.DOCKERHUB_READ_TOKEN != ''
        run: echo "${{ secrets.DOCKERHUB_READ_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Compose up (core profile)
        run: docker compose --profile core up -d --pull=missing

      - name: Wait for health
        run: ./scripts/wait-healthy.sh core