name: Trivy Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  scan-repo:
    name: Scan Repository
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  scan-dockerfile:
    name: Scan Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy on Dockerfiles
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: false
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  scan-iac:
    name: Scan Infrastructure as Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy on IaC
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-iac-results.json'
      
      - name: Upload IaC scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-iac-results-${{ github.sha }}
          path: trivy-iac-results.json
          retention-days: 30

  scan-dependencies:
    name: Scan Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy on Python dependencies
        run: |
          # Install Trivy
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          
          # Scan requirements files
          if [ -f requirements.txt ]; then
            echo "ðŸ“‹ Scanning requirements.txt"
            trivy fs --scanners vuln requirements.txt
          fi
          
          if [ -f pyproject.toml ]; then
            echo "ðŸ“‹ Scanning pyproject.toml"
            trivy fs --scanners vuln pyproject.toml
          fi
          
          # Scan package-lock if exists
          if [ -f package-lock.json ]; then
            echo "ðŸ“‹ Scanning package-lock.json"
            trivy fs --scanners vuln package-lock.json
          fi